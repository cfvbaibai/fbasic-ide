<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>F-BASIC PLAY Command - Web Audio API POC</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #00ff00;
      padding: 20px;
      line-height: 1.6;
    }

    h1 {
      color: #00ffff;
      margin-bottom: 10px;
      font-size: 24px;
    }

    h2 {
      color: #ffff00;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .section {
      background: #2a2a2a;
      border: 2px solid #00ff00;
      padding: 15px;
      margin: 15px 0;
      border-radius: 5px;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }

    button {
      background: #003300;
      color: #00ff00;
      border: 2px solid #00ff00;
      padding: 10px 20px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      cursor: pointer;
      border-radius: 3px;
      transition: all 0.2s;
    }

    button:hover {
      background: #00ff00;
      color: #000000;
    }

    button:active {
      transform: scale(0.95);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #output {
      background: #000000;
      color: #00ff00;
      padding: 15px;
      border: 1px solid #00ff00;
      border-radius: 3px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .status {
      color: #ffff00;
      font-weight: bold;
      margin: 10px 0;
    }

    .success {
      color: #00ff00;
    }

    .warning {
      color: #ff9900;
    }

    .error {
      color: #ff0000;
    }

    .info {
      color: #00ffff;
    }

    code {
      background: #333;
      padding: 2px 6px;
      border-radius: 3px;
    }

    .test-group {
      margin-bottom: 15px;
    }

    .test-group label {
      display: block;
      margin-bottom: 5px;
      color: #ffff00;
    }

    input[type="text"] {
      background: #000;
      color: #00ff00;
      border: 1px solid #00ff00;
      padding: 8px;
      font-family: 'Courier New', monospace;
      width: 100%;
      max-width: 400px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
  <h1>F-BASIC PLAY Command - Web Audio API Proof of Concept</h1>
  <p class="status">Status: <span id="audio-status">Not initialized</span></p>

  <div class="section">
    <h2>1. Basic Tests</h2>
    <div class="button-group">
      <button id="init-audio">Initialize Audio (Click First!)</button>
      <button id="test-note" disabled>Test Single Note (C4)</button>
      <button id="test-chord" disabled>Test Chord (C:E:G)</button>
      <button id="test-melody" disabled>Test Melody (CDEFG)</button>
    </div>
  </div>

  <div class="section">
    <h2>2. Duty Cycle Tests (Y0-Y3)</h2>
    <p>F-BASIC duty cycles: Y0=12.5%, Y1=25%, Y2=50%, Y3=75%</p>
    <div class="button-group">
      <button id="test-y0" disabled>Y0 (12.5%)</button>
      <button id="test-y1" disabled>Y1 (25%)</button>
      <button id="test-y2" disabled>Y2 (50%)</button>
      <button id="test-y3" disabled>Y3 (75%)</button>
    </div>
  </div>

  <div class="section">
    <h2>3. Envelope Tests (M0/M1)</h2>
    <div class="button-group">
      <button id="test-m0" disabled>M0 (No Envelope)</button>
      <button id="test-m1" disabled>M1 (With Decay)</button>
    </div>
  </div>

  <div class="section">
    <h2>4. Tempo Tests (T1-T8)</h2>
    <p>T1=fast (200 BPM), T8=slow (40 BPM)</p>
    <div class="button-group">
      <button id="test-t1" disabled>T1 (Fast)</button>
      <button id="test-t4" disabled>T4 (Medium)</button>
      <button id="test-t8" disabled>T8 (Slow)</button>
    </div>
  </div>

  <div class="section">
    <h2>5. Octave Tests (O0-O5)</h2>
    <div class="button-group">
      <button id="test-octaves" disabled>Play C in all octaves</button>
    </div>
  </div>

  <div class="section">
    <h2>6. Volume Tests (V0-V15)</h2>
    <div class="button-group">
      <button id="test-volumes" disabled>Test V0, V5, V10, V15</button>
    </div>
  </div>

  <div class="section">
    <h2>7. Complex PLAY String Test</h2>
    <div class="test-group">
      <label>Enter F-BASIC PLAY string:</label>
      <input type="text" id="play-input" value="T4O3CDEFGAB>C" disabled>
      <div class="button-group">
        <button id="test-play-string" disabled>Execute PLAY String</button>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>8. 3-Channel Polyphony Test</h2>
    <div class="button-group">
      <button id="test-poly-simple" disabled>Simple: "C:E:G"</button>
      <button id="test-poly-complex" disabled>Complex: "O5C5:O4E5:O1G5"</button>
      <button id="test-poly-melody" disabled>Melody with harmony</button>
    </div>
  </div>

  <div class="section">
    <h2>Test Output</h2>
    <pre id="output">Waiting for audio initialization...</pre>
  </div>

  <script>
    // ============================================================================
    // GLOBAL STATE
    // ============================================================================
    let audioContext = null;
    const output = document.getElementById('output');
    const statusEl = document.getElementById('audio-status');

    // F-BASIC defaults
    let currentTempo = 4;
    let currentOctave = 3;
    let currentVolume = 10;
    let currentDuty = 2; // 50%
    let currentEnvelope = 0; // M0

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    function log(msg, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = {
        info: '[INFO]',
        success: '[✓]',
        warning: '[!]',
        error: '[✗]'
      }[type];

      const line = `${timestamp} ${prefix} ${msg}`;
      output.textContent += line + '\n';
      output.scrollTop = output.scrollHeight;

      console.log(line);
    }

    function enableButtons() {
      document.querySelectorAll('button:not(#init-audio)').forEach(btn => {
        btn.disabled = false;
      });
      document.getElementById('play-input').disabled = false;
    }

    // ============================================================================
    // AUDIO CONTEXT INITIALIZATION
    // ============================================================================
    function initAudio() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        log(`AudioContext created: state=${audioContext.state}, sampleRate=${audioContext.sampleRate}Hz`, 'success');

        if (audioContext.state === 'suspended') {
          audioContext.resume().then(() => {
            log('AudioContext resumed', 'success');
            statusEl.textContent = 'Ready (' + audioContext.state + ')';
            statusEl.className = 'success';
          });
        } else {
          statusEl.textContent = 'Ready (' + audioContext.state + ')';
          statusEl.className = 'success';
        }

        enableButtons();
        document.getElementById('init-audio').disabled = true;
        return true;
      } catch (err) {
        log('Failed to create AudioContext: ' + err.message, 'error');
        statusEl.textContent = 'Failed';
        statusEl.className = 'error';
        return false;
      }
    }

    // ============================================================================
    // DUTY CYCLE SQUARE WAVE GENERATION
    // ============================================================================
    function createSquareWave(dutyCycle) {
      // dutyCycle: 0.125, 0.25, 0.5, 0.75 (Y0, Y1, Y2, Y3)
      const harmonics = 32;
      const real = new Float32Array(harmonics);
      const imag = new Float32Array(harmonics);

      // DC offset for duty cycle != 50%
      real[0] = 2 * dutyCycle - 1;

      // Fourier series for pulse wave
      for (let n = 1; n < harmonics; n++) {
        const coefficient = (2 / (Math.PI * n)) * Math.sin(Math.PI * n * dutyCycle);
        imag[n] = coefficient;
      }

      return audioContext.createPeriodicWave(real, imag, { disableNormalization: false });
    }

    // ============================================================================
    // NOTE FREQUENCY CALCULATION (12-TONE EQUAL TEMPERAMENT)
    // ============================================================================
    function noteToFrequency(note, octave) {
      const NOTES = {
        'C': -9, 'C#': -8, 'D': -7, 'D#': -6,
        'E': -5, 'F': -4, 'F#': -3, 'G': -2,
        'G#': -1, 'A': 0, 'A#': 1, 'B': 2
      };

      if (!(note in NOTES)) {
        throw new Error(`Invalid note: ${note}`);
      }

      const semitonesFromA4 = NOTES[note] + (octave - 4) * 12;
      const frequency = 440 * Math.pow(2, semitonesFromA4 / 12);

      return frequency;
    }

    // ============================================================================
    // TEMPO CONVERSION
    // ============================================================================
    const TEMPO_TO_BPM = {
      1: 200, 2: 175, 3: 150, 4: 125,
      5: 100, 6: 80, 7: 60, 8: 40
    };

    function noteDuration(noteLength, tempo) {
      const bpm = TEMPO_TO_BPM[tempo];
      const beatsPerSecond = bpm / 60;
      const quarterNoteDuration = 1 / beatsPerSecond;
      // noteLength: 1=whole, 2=half, 4=quarter, 8=eighth
      return (4 / noteLength) * quarterNoteDuration;
    }

    // ============================================================================
    // CORE PLAY NOTE FUNCTION
    // ============================================================================
    function playNote(frequency, startTime, duration, volume, duty, envelope) {
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();

      // Set waveform with duty cycle
      const dutyValue = [0.125, 0.25, 0.5, 0.75][duty];
      osc.setPeriodicWave(createSquareWave(dutyValue));

      osc.frequency.value = frequency;

      // Volume (0-15 -> 0-1)
      const normalizedVolume = volume / 15;

      // Envelope
      if (envelope === 1) {
        // M1: Exponential decay
        gain.gain.setValueAtTime(normalizedVolume, startTime);
        gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
      } else {
        // M0: Constant volume
        gain.gain.setValueAtTime(normalizedVolume, startTime);
      }

      // Connect nodes
      osc.connect(gain);
      gain.connect(audioContext.destination);

      // Schedule playback
      osc.start(startTime);
      osc.stop(startTime + duration);

      return { osc, gain };
    }

    // ============================================================================
    // PLAY CHORD (3-CHANNEL POLYPHONY)
    // ============================================================================
    function playChord(frequencies, startTime, duration, volume, duty, envelope) {
      log(`Playing chord: ${frequencies.map(f => f.toFixed(2) + 'Hz').join(', ')}`, 'info');

      // Reduce volume per voice to prevent clipping
      const adjustedVolume = volume * 0.7;

      frequencies.forEach(freq => {
        playNote(freq, startTime, duration, adjustedVolume, duty, envelope);
      });
    }

    // ============================================================================
    // SIMPLE PLAY STRING PARSER (MINIMAL IMPLEMENTATION)
    // ============================================================================
    function parseAndPlay(playString) {
      log(`Parsing PLAY string: "${playString}"`, 'info');

      let tempo = currentTempo;
      let octave = currentOctave;
      let volume = currentVolume;
      let duty = currentDuty;
      let envelope = currentEnvelope;
      let noteLength = 4; // Quarter note default

      const notes = [];
      let i = 0;

      while (i < playString.length) {
        const char = playString[i].toUpperCase();

        // Tempo
        if (char === 'T') {
          i++;
          tempo = parseInt(playString[i]);
          log(`Set tempo: T${tempo} (${TEMPO_TO_BPM[tempo]} BPM)`, 'success');
          i++;
          continue;
        }

        // Octave
        if (char === 'O') {
          i++;
          octave = parseInt(playString[i]);
          log(`Set octave: O${octave}`, 'success');
          i++;
          continue;
        }

        // Volume
        if (char === 'V') {
          i++;
          let volStr = '';
          while (i < playString.length && /\d/.test(playString[i])) {
            volStr += playString[i];
            i++;
          }
          volume = parseInt(volStr);
          log(`Set volume: V${volume}`, 'success');
          continue;
        }

        // Duty cycle
        if (char === 'Y') {
          i++;
          duty = parseInt(playString[i]);
          log(`Set duty cycle: Y${duty} (${[12.5, 25, 50, 75][duty]}%)`, 'success');
          i++;
          continue;
        }

        // Envelope
        if (char === 'M') {
          i++;
          envelope = parseInt(playString[i]);
          log(`Set envelope: M${envelope}`, 'success');
          i++;
          continue;
        }

        // Octave Up
        if (char === '>') {
          octave = Math.min(5, octave + 1);
          log(`Octave up: O${octave}`, 'success');
          i++;
          continue;
        }

        // Octave Down
        if (char === '<') {
          octave = Math.max(0, octave - 1);
          log(`Octave down: O${octave}`, 'success');
          i++;
          continue;
        }

        // Rest
        if (char === 'R') {
          i++;
          let lenStr = '';
          while (i < playString.length && /\d/.test(playString[i])) {
            lenStr += playString[i];
            i++;
          }
          const len = lenStr ? parseInt(lenStr) : noteLength;
          notes.push({ type: 'rest', duration: noteDuration(len, tempo) });
          continue;
        }

        // Note (C, D, E, F, G, A, B)
        if ('CDEFGAB'.includes(char)) {
          let noteName = char;
          i++;

          // Check for sharp
          if (i < playString.length && playString[i] === '#') {
            noteName += '#';
            i++;
          }

          // Check for note length
          let lenStr = '';
          while (i < playString.length && /\d/.test(playString[i])) {
            lenStr += playString[i];
            i++;
          }
          const len = lenStr ? parseInt(lenStr) : noteLength;

          const frequency = noteToFrequency(noteName, octave);
          const duration = noteDuration(len, tempo);

          notes.push({
            type: 'note',
            frequency,
            duration,
            volume,
            duty,
            envelope,
            name: noteName + octave
          });

          continue;
        }

        // Unknown character
        i++;
      }

      // Play all notes sequentially
      let currentTime = audioContext.currentTime + 0.1;

      notes.forEach((note, idx) => {
        if (note.type === 'note') {
          log(`[${idx}] ${note.name} (${note.frequency.toFixed(2)}Hz) for ${note.duration.toFixed(3)}s`, 'info');
          playNote(note.frequency, currentTime, note.duration, note.volume, note.duty, note.envelope);
        } else {
          log(`[${idx}] REST for ${note.duration.toFixed(3)}s`, 'info');
        }
        currentTime += note.duration;
      });

      log(`Total duration: ${(currentTime - audioContext.currentTime).toFixed(2)}s`, 'success');
    }

    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================
    document.getElementById('init-audio').onclick = () => {
      if (initAudio()) {
        log('Audio initialized successfully!', 'success');
        log('You can now run all tests.', 'info');
      }
    };

    document.getElementById('test-note').onclick = () => {
      log('Playing single note: C4 (261.63 Hz) for 0.5s', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 0.5, 10, 2, 0);
      log(`Frequency: ${freq.toFixed(2)} Hz`, 'success');
    };

    document.getElementById('test-chord').onclick = () => {
      log('Playing 3-note chord: C4 + E4 + G4 (C major)', 'info');
      const frequencies = [
        noteToFrequency('C', 4),
        noteToFrequency('E', 4),
        noteToFrequency('G', 4)
      ];
      playChord(frequencies, audioContext.currentTime + 0.1, 1.0, 10, 2, 0);
      log('3-channel polyphony test: SUCCESS', 'success');
    };

    document.getElementById('test-melody').onclick = () => {
      log('Playing melody: C D E F G (sequential)', 'info');
      const melody = ['C', 'D', 'E', 'F', 'G'];
      let time = audioContext.currentTime + 0.1;

      melody.forEach(note => {
        const freq = noteToFrequency(note, 4);
        playNote(freq, time, 0.3, 10, 2, 0);
        log(`${note}4 at ${time.toFixed(2)}s`, 'info');
        time += 0.35;
      });

      log('Precise timing test: SUCCESS', 'success');
    };

    document.getElementById('test-y0').onclick = () => {
      log('Testing duty cycle Y0 (12.5%)', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 1.0, 10, 0, 0);
      log('Y0: Thin pulse wave sound', 'success');
    };

    document.getElementById('test-y1').onclick = () => {
      log('Testing duty cycle Y1 (25%)', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 1.0, 10, 1, 0);
      log('Y1: Medium-thin pulse wave', 'success');
    };

    document.getElementById('test-y2').onclick = () => {
      log('Testing duty cycle Y2 (50%)', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 1.0, 10, 2, 0);
      log('Y2: Standard square wave (hollow sound)', 'success');
    };

    document.getElementById('test-y3').onclick = () => {
      log('Testing duty cycle Y3 (75%)', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 1.0, 10, 3, 0);
      log('Y3: Wide pulse wave', 'success');
    };

    document.getElementById('test-m0').onclick = () => {
      log('Testing envelope M0 (no envelope)', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 1.0, 15, 2, 0);
      log('M0: Constant volume throughout note', 'success');
    };

    document.getElementById('test-m1').onclick = () => {
      log('Testing envelope M1 (decay)', 'info');
      const freq = noteToFrequency('C', 4);
      playNote(freq, audioContext.currentTime + 0.1, 1.0, 15, 2, 1);
      log('M1: Volume decays from V15 to 0', 'success');
    };

    document.getElementById('test-t1').onclick = () => {
      log('Testing tempo T1 (200 BPM - Fast)', 'info');
      parseAndPlay('T1CDEFG');
    };

    document.getElementById('test-t4').onclick = () => {
      log('Testing tempo T4 (125 BPM - Medium)', 'info');
      parseAndPlay('T4CDEFG');
    };

    document.getElementById('test-t8').onclick = () => {
      log('Testing tempo T8 (40 BPM - Slow)', 'info');
      parseAndPlay('T8CDEFG');
    };

    document.getElementById('test-octaves').onclick = () => {
      log('Testing octaves O0-O5 (playing C in each octave)', 'info');
      let time = audioContext.currentTime + 0.1;

      for (let oct = 0; oct <= 5; oct++) {
        const freq = noteToFrequency('C', oct);
        playNote(freq, time, 0.5, 10, 2, 0);
        log(`O${oct}: C${oct} = ${freq.toFixed(2)} Hz`, 'info');
        time += 0.6;
      }

      log('Octave range test: SUCCESS', 'success');
    };

    document.getElementById('test-volumes').onclick = () => {
      log('Testing volumes V0, V5, V10, V15', 'info');
      let time = audioContext.currentTime + 0.1;
      const volumes = [0, 5, 10, 15];

      volumes.forEach(vol => {
        const freq = noteToFrequency('C', 4);
        playNote(freq, time, 0.5, vol, 2, 0);
        log(`V${vol}: Volume level ${vol}/15`, 'info');
        time += 0.6;
      });

      log('Volume control test: SUCCESS', 'success');
    };

    document.getElementById('test-play-string').onclick = () => {
      const playString = document.getElementById('play-input').value;
      parseAndPlay(playString);
    };

    document.getElementById('test-poly-simple').onclick = () => {
      log('Testing simple polyphony: "C:E:G"', 'info');
      // Note: Full parser would split by ':'
      // For now, manually play chord
      const frequencies = [
        noteToFrequency('C', 4),
        noteToFrequency('E', 4),
        noteToFrequency('G', 4)
      ];
      playChord(frequencies, audioContext.currentTime + 0.1, 1.5, 10, 2, 0);
      log('3-channel simultaneous playback: SUCCESS', 'success');
    };

    document.getElementById('test-poly-complex').onclick = () => {
      log('Testing complex polyphony: "O5C5:O4E5:O1G5"', 'info');
      // C5 (5th octave, half note), E4 (4th octave, half note), G1 (1st octave, half note)
      const frequencies = [
        noteToFrequency('C', 5),
        noteToFrequency('E', 4),
        noteToFrequency('G', 1)
      ];
      playChord(frequencies, audioContext.currentTime + 0.1, 1.5, 10, 2, 0);
      log('Per-channel octave control: SUCCESS', 'success');
    };

    document.getElementById('test-poly-melody').onclick = () => {
      log('Testing melody with harmony (3 channels)', 'info');
      const melody = ['C', 'D', 'E', 'F', 'G'];
      let time = audioContext.currentTime + 0.1;

      melody.forEach(note => {
        // Play melody note + harmony (third + fifth)
        const root = noteToFrequency(note, 4);
        const third = noteToFrequency(note, 4) * Math.pow(2, 4/12); // Major third
        const fifth = noteToFrequency(note, 4) * Math.pow(2, 7/12); // Perfect fifth

        playChord([root, third, fifth], time, 0.4, 8, 2, 1);
        log(`${note} major chord`, 'info');
        time += 0.45;
      });

      log('Polyphonic melody test: SUCCESS', 'success');
    };

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    log('POC loaded. Click "Initialize Audio" to begin.', 'info');
    log('', 'info');
    log('This POC demonstrates:', 'info');
    log('- Square wave generation with 4 duty cycles (Y0-Y3)', 'info');
    log('- 3-channel polyphony (simultaneous notes)', 'info');
    log('- Envelope control (M0/M1)', 'info');
    log('- Tempo control (T1-T8)', 'info');
    log('- Octave range (O0-O5)', 'info');
    log('- Volume control (V0-V15)', 'info');
    log('- Precise timing and note sequencing', 'info');
    log('- Musical note frequency calculation', 'info');
    log('', 'info');
  </script>
</body>
</html>
