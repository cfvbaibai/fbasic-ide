type: bug
subject: Shooting game only shows MARIO as enemies
description: The enemy character types should be random, but we always see 8 MARIOs

## Investigation Summary

This bug has been investigated and the root cause has been identified.

### Issue
The shooting game (`sampleCodes.shooting`) uses `DEF MOVE(X)=SPRITE(RND(16),RND(9),5,50,0,0)` in a subroutine called 8 times via `FOR X=0 TO 7:GOSUB 1000:NEXT`. All 8 enemies show as MARIO (character type 0) instead of random character types.

### Root Cause Analysis

**The BASIC execution engine is working correctly.** The RND function returns different random values on each call, and the characterTypes are correctly stored in the shared buffer.

**Evidence:**
- Created integration test (`test/integration/ShootingGameBug.test.ts`) that exactly reproduces the shooting game initialization pattern
- Test result: characterTypes created were `[5, 6, 8, 12, 11, 10, 7, 11]` - **7 unique values out of 8**
- This confirms RND(16) correctly returns random values and DEF MOVE stores them correctly

**The bug is in the visual rendering layer**, not the BASIC execution:
1. ✓ RND function works correctly
2. ✓ DEF MOVE stores characterTypes correctly in buffer (offset base + 10)
3. ✓ Shared buffer accessor correctly reads characterTypes
4. ✗ Visual rendering shows all sprites as MARIO

### Code Investigation Results

**Investigated components:**
1. `FunctionEvaluator.evaluateRnd()` - RND function uses `Math.random()` correctly
2. `DefMoveExecutor.execute()` - Correctly evaluates RND expressions and stores characterType
3. `AnimationManager.defineMovement()` - Correctly writes characterType to shared buffer via `writeSpriteState()`
4. `SharedDisplayBufferAccessor` - Buffer layout correct, characterType at offset base + 10
5. `useKonvaSpriteRenderer` - Cache key includes characterType: `${actionNumber}-${characterType}-${direction}-${colorCombination}-${spritePaletteCode}`
6. `CharacterAnimationBuilder` - Animation configs built for all 16 character types

### Next Steps (for future investigation)

The bug is in the frontend sprite rendering pipeline. Possible causes:
1. Rendering code may be reading from a stale/different buffer instance
2. Cache invalidation issue when program re-runs
3. Timing issue between worker writes and main thread reads

**Recommendation:** Run the shooting game in the IDE with the added debug logging in `useKonvaSpriteRenderer.ts` to see what characterTypes are being read during rendering.

### Files Modified
- `test/integration/ShootingGameBug.test.ts` - Created reproduction test
- `test/executors/DefMoveExecutor.test.ts` - Added RND tests
- `src/features/ide/composables/useKonvaSpriteRenderer.ts` - Added debug logging
