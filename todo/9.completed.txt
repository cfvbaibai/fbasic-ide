type: feature
status: completed
subject: BG GRAPHIC Editor
description: |
  ## Overview

  Implement a BG GRAPHIC editor to enable users to create/edit background graphics,
  unblocking the VIEW command.

  **Architecture Note:** BG Editor is NOT a standalone route. It is integrated into
  the IDE page as a view toggle (Code / BG Editor). Background data binds to the
  program context - a game consists of foreground (sprites), print (text), and
  background (BG GRAPHIC).

  ## Implementation Summary

  ### Completed Features:

  1. **BG Editor UI** (`src/features/bg-editor/`)
     - Types and constants for 28×21 grid
     - Composables: useBgGrid, useBgStorage, useBgEditorState, useBgRenderer
     - Components: BgEditorPage, BgToolbar, BgGrid, BgPalette, BgColorPattern
     - Canvas-based rendering with proper scaling
     - LocalStorage persistence
     - i18n support (en, ja, zh-CN, zh-TW)

  2. **VIEW Command** (`src/core/`)
     - Added VIEW token to parser (`parser-tokens.ts`)
     - Added viewStatement grammar rule (`FBasicChevrotainParser.ts`)
     - Created ViewExecutor (`execution/executors/ViewExecutor.ts`)
     - Registered in StatementRouter
     - Added copyBgGraphicToBackground to device adapters

  3. **IDE Integration**
     - BG Editor integrated into IDE as view toggle (Code / BG)
     - Removed standalone /bg-editor route
     - Background data binds to program context

  4. **Tests**
     - All 1216 tests passing
     - ViewStatement parser tests included

  5. **Worker Communication Fix** (2026-02-19)
     - Added SET_BG_DATA message type for main thread → worker communication
     - BG Editor data now sent to worker before code execution
     - Enables VIEW command to access BG content during runtime
     - Files: `interfaces.ts`, `WebWorkerInterpreter.ts`, `useBasicIdeWebWorkerUtils.ts`,
       `useBasicIdeWorkerIntegration.ts`, `useBasicIdeExecution.ts`

  6. **Sample Code**
     - Added "BG VIEW Test" sample to sampleCodes.ts for manual testing

  ## Files Created/Modified:

  - `src/features/bg-editor/` - New feature directory
  - `src/features/bg-editor/components/BgEditorPanel.vue` - Panel for IDE integration
  - `src/features/ide/IdePage.vue` - Added Code/BG view toggle
  - `src/core/parser/parser-tokens.ts` - VIEW token
  - `src/core/parser/FBasicChevrotainParser.ts` - VIEW grammar
  - `src/core/execution/executors/ViewExecutor.ts` - New executor
  - `src/core/execution/StatementRouter.ts` - VIEW routing
  - `src/core/interfaces.ts` - copyBgGraphicToBackground interface
  - `src/core/devices/WebWorkerDeviceAdapter.ts` - copyBgGraphicToBackground implementation
  - `src/core/devices/TestDeviceAdapter.ts` - copyBgGraphicToBackground for testing
  - `src/shared/i18n/` - BG Editor translations
  - `src/router/index.ts` - Removed /bg-editor route (integrated into IDE)
  - `src/core/samples/sampleCodes.ts` - Added BG VIEW Test sample

  ## Reference

  - `docs/reference/family-basic-manual/page-36.md` — Screen Display Process
  - `docs/archive/planning/bg-editor-implementation-plan.md` — Original plan
